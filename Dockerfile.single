# ================================================
# Stage 1: Build Frontend
# ================================================
FROM node:20-alpine AS frontend-builder

WORKDIR /frontend

# Copy frontend package files
COPY frontend/web/package*.json ./
RUN npm install

# Copy frontend source
COPY frontend/web ./

# Build static export
# Note: Next.js needs NEXT_PUBLIC_ vars at build time
ARG NEXT_PUBLIC_API_BASE_URL=/api
ENV NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}

RUN npm run build

# ================================================
# Stage 2: Build Backend + Runtime
# ================================================
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    nginx \
    supervisor \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy backend code
COPY finantradealgo/ ./finantradealgo/
COPY scripts/ ./scripts/
COPY pyproject.toml ./
COPY README.md ./

# Install backend package
RUN pip install -e .

# Copy frontend static build from stage 1
COPY --from=frontend-builder /frontend/out /app/frontend/out

# Copy configuration files
COPY docker/single/nginx.conf /etc/nginx/nginx.conf
COPY docker/single/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Create required directories
RUN mkdir -p /app/data /app/outputs /app/config /var/log/supervisor /var/log/nginx

# Expose single port
EXPOSE 8080

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV BACKEND_HOST=127.0.0.1
ENV BACKEND_PORT=8000

# Start supervisor (manages nginx + uvicorn)
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
